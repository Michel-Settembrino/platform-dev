<?php

/**
 * @file
 * Code for the NextEuropa webtools feature.
 */

include_once 'nexteuropa_webtools.features.inc';

/**
 * Implements hook_menu().
 */
function nexteuropa_webtools_menu() {
  $items = array();
  $items['admin/config/services/webtools'] = array(
    'title' => 'Webtools',
    'description' => 'Webtools settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nexteuropa_webtools_settings_form'),
    'access arguments' => array('administer webtools'),
    'file' => 'nexteuropa_webtools.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function nexteuropa_webtools_permission() {
  return array(
    'administer webtools' => array(
      'title' => t('Administer webtools'),
      'description' => t('Administer nexteuropa_webbools feature.'),
    ),
    'webtools custom js' => array(
      'title' => t('Webtools custom js'),
      'description' => t('Allows users to upload a custom js in webtools bean.'),
    ),
  );
}

/**
 * Implements hook_json_field_js_to_load().
 */
function nexteuropa_webtools_json_field_js_to_load() {
  return array('nexteuropa_webtools_smartloader_prurl' => t('Webtools load.js'));
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function nexteuropa_webtools_form_bean_form_alter(&$form, &$form_state) {
  if (isset($form['#entity'])) {
    if ($form['#entity']->type !== 'webtools') {
      return;
    }
  }

  $access = user_access('webtools custom js');
  // Following fields are only visible when above mentioned permission is
  // granted to the user using the bean form.
  // This because we don't want the field values to be changed when resubmitting
  // the form with a role not granted with above mentoined permission.
  $form['field_custom_js_link']['#access'] = $access;
  // No need to add a custom submit handler, the handling of the fields and json
  // object will be done in hook_bean_submit().
}

/**
 * Implements hook_bean_submit().
 *
 * Use the custom_js fields to change the json_object in bean 'webtools'.
 *
 * @see bean_form_submit()
 * @see bean_form_submit_build_bean()
 */
function nexteuropa_webtools_bean_submit(&$bean, &$form, &$form_state) {
  // At this point, the values in form_state were copied to the bean. So we can
  // use both the values or the bean fields itself to change the json_object.
  // The values from the form_state will be copied to the bean again after this
  // hook.
  // I will prefer to use the form_state regarding the json_object and the bean
  // for checking the field values that do not have to change.
  // E.g. field_custom_js_file.
  if ($bean->type !== 'webtools') {
    return;
  }
  $values = &$form_state['values'];
  // This array will allow us to get and set the json_object value
  // multiple times from and to the form_state.
  $json_object_parents = array('field_json_object', LANGUAGE_NONE, 0, 'value');
  $json_object = drupal_array_get_nested_value($values, $json_object_parents);
  // Do not try to change an empty json_object.
  if (empty($json_object)) {
    return;
  }
  // Decoded json object is easier to use.
  $json_object = json_decode($json_object);
  // First, strip the "custom" attribute from the json_object.
  if (!empty($json_object->custom)) {
    unset($json_object->custom);
    // Set the updated object back in the form_state, allowing us to bail out
    // early. DO NOT FORGET TO ENCODE!
    drupal_array_set_nested_value($values, $json_object_parents, json_encode($json_object));
  }

  $field_custom_js_status = field_get_items('bean', $bean, 'field_custom_js_status');
  // Do not set the "custom" attribute when this has been turned off.
  if (empty($field_custom_js_status) || $field_custom_js_status[0]['value'] === 0) {
    return;
  }

  $field_custom_js_link = field_get_items('bean', $bean, 'field_custom_js_link');
  // Add the absolute url as "custom" attribute.
  if (!empty($field_custom_js_link)) {
    $url = $field_custom_js_link[0]['url'];
    if (url_is_external($url)) {
      $url = '//' . file_uri_target($url);
    }
    else {
      $url = base_path() . $url;
    }

    $json_object->custom = $url;
    // Add the JSON_UNESCAPED_SLASHES option to json_encode because we need the
    // full url in the json_object.
    drupal_array_set_nested_value($values, $json_object_parents, json_encode($json_object, JSON_UNESCAPED_SLASHES));
  }
}
